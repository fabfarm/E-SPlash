<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Fabfarm Irrigation Setup Page</title>
		<link rel="shortcut icon" type="image/png" href="/favicon.ico"/>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta charset="UTF-8" />
		<link rel="stylesheet" type="text/css" href="/all.css" />
		<link rel="stylesheet" type="text/css" href="/style.css" />
		<link href="/bootstrap.min.css" rel="stylesheet" />
		<style>
			body {
				background-color: #f7f9fb;
				margin: auto;
			}

			.main-title {
				font-weight: bold;
			}

			.toast {
				bottom: 0;
				right: 5px;
				position: fixed;
				display: none;
			}

			.spinner-container {
				position: fixed;
				bottom: 0;
				right: 5px;
				display: none;
			}

			#schedulingMode {
				width: 100px;
				height: 50px;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid position-relative d-flex align-items-center flex-column">
			<img src="/logo.png" alt="FabFarm Algarve" class="rounded mx-auto d-block p-10 m-5" />
			<h1 class="display-1 main-title">
				<strong>Irrigation System</strong>
			</h1>
			<div class="shadow d-flex w-100 flex-column justify-content-center align-items-center bg-white rounded p-4 m-2">
				<h5 id="currentTime" class="m-2"></h5>
			</div>
			<div id="main">
				<div class="shadow d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center flex-column">
					<h6 class="display-6 main-title"><strong>Date and time</strong></h6>
					<div class="d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center">
						<form id = "timeform" class= "form">
							<div>Date : <input type="date" id="date" name="date" style="width:130px;" /></div>
							<div>Time : <input type="time" id="time" name="time" style="width:70px;" /></div>
							<button class="btn btn-primary" onClick="updateTime(this)">Change time and date</button>
						</form>
					</div>
					<div class="d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center">
						<div class="form-check form-switch">
							<input type="checkbox" id="useInternetTime" onclick="enableInternetUpdate(this)" value="true">
						</div>
						<span class="m-2 display-6">Use internet time</span>
					</div>
					<div class="d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center">
						<label for="utcOffset" class="m-2 display-6">UTC Offset (hours):</label>
						<select id="utcOffset" onchange="updateUTCOffset()" style="width:100px;">
							<option value="-12">UTC-12</option>
							<option value="-11">UTC-11</option>
							<option value="-10">UTC-10</option>
							<option value="-9">UTC-9</option>
							<option value="-8">UTC-8</option>
							<option value="-7">UTC-7</option>
							<option value="-6">UTC-6</option>
							<option value="-5">UTC-5</option>
							<option value="-4">UTC-4</option>
							<option value="-3">UTC-3</option>
							<option value="-2">UTC-2</option>
							<option value="-1">UTC-1</option>
							<option value="0">UTC+0</option>
							<option value="1" selected>UTC+1</option>
							<option value="2">UTC+2</option>
							<option value="3">UTC+3</option>
							<option value="4">UTC+4</option>
							<option value="5">UTC+5</option>
							<option value="6">UTC+6</option>
							<option value="7">UTC+7</option>
							<option value="8">UTC+8</option>
							<option value="9">UTC+9</option>
							<option value="10">UTC+10</option>
							<option value="11">UTC+11</option>
							<option value="12">UTC+12</option>
						</select>
					</div>
				</div>
				<div class="shadow d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center flex-column">
					<h6 class="display-6 main-title"><strong>Sensors</strong></h6>
				</div>
				<div class="shadow d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center flex-column">
					<h6 class="display-6 main-title"><strong>Relays</strong></h6>
					<p>This system has 3 fixed irrigation zones plus a pump relay.<br/>
					   The relays are hardware-configured and cannot be modified through software.</p>
					<table id="productTable">
						<thead>
							<tr>
							   <th>Zone Name</th>
							   <th>Current Status</th>
							</tr>
						</thead>
						<tbody id="relays"></tbody>
					</table>
				</div>
				<div class="shadow d-flex align-items-center bg-white rounded p-4 m-2 justify-content-center flex-column">
					<h6 class="display-6 main-title"><strong>Wifi Credentials</strong></h6>
					<p>Note: WiFi credentials are stored in the credentials.txt file.<br/>
					   Multiple networks can be configured. Device will automatically connect to available networks.</p>
					<form id = "credentialsform" class= "form">
						<div>SSID: <input type="text" name="ssid" id="ssid" placeholder="Network name"></div>
						<div>Password: <input type="text" name="password" id="password"  placeholder="Network password"></div>
						<button type="button" class="btn btn-primary" onClick="updateCredentials(this)">Add WiFi Network</button>
					</form>
					<div id="current-networks">
						<h6>Current Networks:</h6>
						<ul id="network-list"></ul>
					</div>
				</div>
			</div>
			<hr />
			<a href="/update" class="btn btn-primary">Update Firmware</a><br />
			<a href="/" class="btn btn-primary">Back to Control Page</a>
			<div class="toast-container position-fixed">
				<div id="toast-error" class="toast p-1 text-white bg-danger align-items-center">
					<div class="d-flex w-100">
						<div class="toast-body" id="toast-error-body"></div>
						<button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast-error" aria-label="Close" onclick="closeErrorToast()"></button>
					</div>
				</div>
				<div class="spinner-border spinner-container text-primary" id="spinner-bottom-right" role="status">
					<span class="visually-hidden">Loading...</span>
				</div>
				<div id="toast-success" class="toast p-1 text-white bg-success align-items-center">
					<div class="d-flex w-100">
						<div class="toast-body" id="toast-success-body">Success</div>
						<button class="btn-close btn-close-white me-2 m-auto" aria-label="Close" onclick="closeSuccessToast()"></button>
					</div>
				</div>
			</div>
		</div>
		<script src="/script.js"></script>
		<script type="text/javascript">
			var jsonData; 
			function updateCredentials(obj){
				var ssid = document.getElementById("ssid").value.trim();
				var password = document.getElementById("password").value.trim();
				
				if (!ssid) {
					alert("Please enter a network name (SSID)");
					return;
				}
				
				// Send credentials as form data to a dedicated endpoint
				var formData = new FormData();
				formData.append('ssid', ssid);
				formData.append('password', password);
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function() {
					if (this.readyState == 4) {
						if (this.status == 200) {
							alert("WiFi credentials added successfully");
							document.getElementById("ssid").value = "";
							document.getElementById("password").value = "";
							loadNetworkList(); // Refresh the network list
						} else {
							alert("Error adding WiFi credentials");
						}
					}
				};
				xmlhttp.open("POST", "/wifi/add");
				xmlhttp.send(formData);
			}

			function loadNetworkList() {
				// Load and display current networks from credentials file
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						var networks = this.responseText.split('\n').filter(line => line.trim());
						var networkList = document.getElementById("network-list");
						networkList.innerHTML = "";
						
						networks.forEach(function(network) {
							if (network.trim()) {
								var ssid = network.split(',')[0];
								var li = document.createElement('li');
								li.textContent = ssid;
								networkList.appendChild(li);
							}
						});
					}
				};
				xmlhttp.open("GET", "/wifi/list");
				xmlhttp.send();
			}

			function updateRelays(obj) {
				var1 = document.getElementById("relayname").value;
				var2 = document.getElementById("relaypin").value;
				var3 = document.getElementById("relaystatus").value;
				// for(var i = 0; i < jsonData.relays.length; i++) { 
				//	if var2 = jsonData.relays[i].times.pin ; 
				// }
				jsonData.relay[0].name
				var json = JSON.stringify(jsonData);
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("POST", "/updateData");
				xmlhttp.setRequestHeader("Content-Type", "application/json;");
				xmlhttp.send(json);
			}

			function updateTime(obj) {	   
				jsonData.data.changedtime[0].manualtimeenabled =0;
				var fl1= document.getElementById("date").value;
				var fl2= document.getElementById("time").value;
				jsonData.data.changedtime[0].Ttime = fl2 ;
				var timex = (new Date(fl1));
				var hour = fl2.split(":")[0];
				var min = fl2.split(":")[1];
				var day = timex.getDate();
				var month = timex.getMonth();
				var year = timex.getYear();
				jsonData.data.changedtime[0].min= parseInt(min);
				jsonData.data.changedtime[0].hour= parseInt(hour);
				jsonData.data.changedtime[0].day= day ;
				jsonData.data.changedtime[0].month= month+1;
				jsonData.data.changedtime[0].year= year +1900;
				console.log(day);
				console.log(jsonData.data.changedtime[0].day);
				console.log(jsonData.data.changedtime.year);
				var json = JSON.stringify(jsonData);
				var xmlhttp = new XMLHttpRequest();   
				xmlhttp.open("POST", "/updateData");
				xmlhttp.setRequestHeader("Content-Type", "application/json;");
				xmlhttp.send(json);
				return;
			}

			function refresh() {
				var r3 = new XMLHttpRequest();
				r3.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						jsonData = JSON.parse(this.responseText);
						document.getElementById("currentTime").innerText = jsonData.data.currentTime;
						//document.getElementById("date").innerText
						document.getElementById("time").innerText = jsonData.data.changedtime[0].Ttime;
						document.getElementById("useInternetTime").checked = jsonData.data.changedtime[0].internettime;
						
						// Set UTC offset if available
						if (jsonData.data.changedtime[0].utcOffset !== undefined) {
							document.getElementById("utcOffset").value = jsonData.data.changedtime[0].utcOffset;
						}
						
						var htmlrelay = "";
						for(var i = 0; i  < jsonData.relays.length; i++) {
							var relay =  jsonData.relays[i];
							if (relay.isEnabled == 1){
								var status = "ON";
							}
							else{
								var status = "OFF";
							}	   
							if  (relay.active ==1 ){
								htmlrelay+=  
							   `<tr>
									<td>${relay.name}</td>
									<td>${status}</td>
								</tr>`
							}
						}

						var main = document.getElementById("relays");
						main.innerHTML = htmlrelay;
					}
				};

				r3.open("GET", "/data.json", true);
				r3.timeout = 2000;
				r3.ontimeout = function(e) {
					// retry
					refresh();
				};
				// for testing:
				//r3.open("GET", "sample.json", true);
				r3.send();

			};
			refresh();
			loadNetworkList(); // Load current WiFi networks

			function enableInternetUpdate() {
				jsonData.data.changedtime[0].internettime = document.getElementById("useInternetTime").checked ? 1 : 0;
				var json = JSON.stringify(jsonData);
				var xmlhttp = new XMLHttpRequest();   
				xmlhttp.open("POST", "/updateData");
				xmlhttp.setRequestHeader("Content-Type", "application/json;");
				xmlhttp.send(json);
				return;
			}

			function updateUTCOffset() {
				if (!jsonData.data.changedtime[0]) {
					jsonData.data.changedtime[0] = {};
				}
				jsonData.data.changedtime[0].utcOffset = parseInt(document.getElementById("utcOffset").value);
				var json = JSON.stringify(jsonData);
				var xmlhttp = new XMLHttpRequest();   
				xmlhttp.open("POST", "/updateData");
				xmlhttp.setRequestHeader("Content-Type", "application/json;");
				xmlhttp.send(json);
				console.log("UTC offset updated to:", jsonData.data.changedtime[0].utcOffset);
				return;
			}

			function ManualChangeCredentials(f1,f2) {
				var ssid= document.getElementById(f1).innerText;
				var pass= document.getElementById(f2).innerText;

				console.log(ssid);
				console.log(pass);

				return;
			}
		</script>
	</body>
</html>